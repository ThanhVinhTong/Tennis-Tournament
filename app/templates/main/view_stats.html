{% extends "base.html" %}
{% block title %}Match Analytics{% endblock %}

{% block content %}
<style>
  .kpi-card {
    width: 150px;
    height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  .kpi-card .card-body {
    padding: 10px;
  }
  .kpi-card small {
    font-size: 0.8em;
  }
  .kpi-card h3 {
    margin: 0;
    font-size: 1.5em;
  }
</style>
<div class="container-fluid">
  <h2 class="mb-4">Match Analytics Dashboard</h2>

  <!-- KPI 卡片 -->
  <div class="row mb-4">
    {% set cards = [
      ('Total Matches', total_matches),
      ('Busiest Month', busiest_month),
      ('Avg Matches/Month', avg_per_month),
      ('Highest Win %', highest_win_player ~ ' (' ~ highest_win_pct ~ '%)'),
      ('Lowest Win %', lowest_win_player ~ ' (' ~ lowest_win_pct ~ '%)')
    ] %}
    {% for title,value in cards %}
    <div class="col-md-2 mb-3">
      <div class="card shadow-sm kpi-card text-center">
        <div class="card-body">
          <small class="text-muted">{{ title }}</small>
          <h3 class="mt-2">{{ value }}</h3>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- 胜场排行榜 -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white">Win Leaderboard</div>
        <div class="card-body table-responsive">
          <table class="table table-striped mb-0">
            <thead><tr><th>Rank</th><th>Player</th><th>Wins</th></tr></thead>
            <tbody>
              {% for entry in leaderboard %}
              <tr>
                <td>#{{ loop.index }}</td>
                <td>{{ entry.player }}</td>
                <td>{{ entry.wins }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 图表区域 -->
  <div class="row">
    <!-- Bar: Matches Played per Player -->
    <div class="col-lg-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">Matches Played per Player</div>
        <div class="card-body"><canvas id="playedBar" height="200"></canvas></div>
      </div>
    </div>
    <!-- Bar: Wins vs Losses -->
    <div class="col-lg-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">Wins vs Losses</div>
        <div class="card-body"><canvas id="winLossBar" height="200"></canvas></div>
      </div>
    </div>
    <!-- Line: Monthly Match Trend -->
    <div class="col-lg-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-info text-white">Monthly Match Trend</div>
        <div class="card-body"><canvas id="trendLine" height="200"></canvas></div>
      </div>
    </div>
    <!-- Pie: Win Distribution -->
    <div class="col-lg-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-warning text-white">Win Distribution</div>
        <div class="card-body"><canvas id="pieChart" height="200"></canvas></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Played per Player
new Chart(document.getElementById('playedBar'), {
  type: 'bar', data: {
    labels: {{ player_names|tojson }},
    datasets: [{ label: 'Played', data: {{ played_counts|tojson }}, backgroundColor: 'rgba(54,162,235,0.6)' }]
  }, options: { responsive: true, scales: { y: { beginAtZero: true, stepSize: 1 } } }
});
// Wins vs Losses
new Chart(document.getElementById('winLossBar'), {
  type: 'bar', data: {
    labels: {{ player_names|tojson }},
    datasets: [
      { label: 'Wins', data: {{ win_counts|tojson }}, backgroundColor: 'rgba(75,192,192,0.6)' },
      { label: 'Losses', data: {{ loss_counts|tojson }}, backgroundColor: 'rgba(255,99,132,0.6)' }
    ]
  }, options: { responsive: true, scales: { y: { beginAtZero: true, stepSize: 1 } } }
});
// Monthly Trend
new Chart(document.getElementById('trendLine'), {
  type: 'line', data: {
    labels: {{ monthly_labels|tojson }},
    datasets: [
      { label: 'Total Matches', data: {{ monthly_totals|tojson }}, fill: false, tension: 0.2 },
      { label: 'Trend', data: {{ trend|tojson }}, fill: false, borderDash: [5,5] }
    ]
  }, options: { responsive: true, scales: { y: { beginAtZero: true, stepSize: 1 } } }
});
// Win Distribution Pie
new Chart(document.getElementById('pieChart'), {
  type: 'pie', data: {
    labels: {{ pie_labels|tojson }},
    datasets: [{ data: {{ pie_data|tojson }}, backgroundColor: ['rgba(255,99,132,0.6)','rgba(54,162,235,0.6)','rgba(255,206,86,0.6)','rgba(75,192,192,0.6)','rgba(153,102,255,0.6)'] }]
  }, options: { responsive: true }
});
</script>
{% endblock %}
{% extends "base.html" %}
{% block title %}Match Analytics{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col">
      <h2><i class="fas fa-chart-bar me-2"></i>Match Analytics Dashboard</h2>
      <p class="text-muted">Your personal stats and private shares analytics</p>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="row mb-5">
    {% for key,label in [
        ('total_matches','Matches Played'),
        ('win_count','Matches Won'),
        ('win_percentage','Win %'),
        ('win_loss_ratio','W/L Ratio')
      ] %}
    <div class="col-sm-6 col-md-3 mb-4">
      <div class="card h-100 text-center shadow-sm">
        <div class="card-body">
          <p class="text-muted small mb-2">{{ label }}</p>
          <h3 class="fw-bold mb-0">{{ stats[key] }}</h3>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Global Leaderboard -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
          <i class="fas fa-trophy me-2"></i>Global Leaderboard
        </div>
        <div class="card-body table-responsive">
          <table class="table table-striped">
            <thead><tr><th>Rank</th><th>Username</th><th>Wins</th></tr></thead>
            <tbody>
              {% for u in global_ranking %}
              <tr>
                <td>#{{ loop.index }}</td>
                <td>{{ u.username }}</td>
                <td>{{ u.win_count }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts: Performance & Private Shares -->
  <div class="row mb-4">
    <div class="col-lg-6 mb-4">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-success text-white">
          <i class="fas fa-chart-line me-2"></i>Performance Trends
        </div>
        <div class="card-body">
          <canvas id="personalChart" height="250"></canvas>
        </div>
      </div>
    </div>

    <!-- Player Participation & Win Rate Distribution Bar Chart -->
    <div class="col-lg-6 mb-4">
       <div class="card h-100 shadow-sm">
          <div class="card-header bg-warning text-white">
            <i class="fas fa-user-friends me-2"></i>Player Performance
          </div>
          <div class="card-body">
            <canvas id="playerChart" height="250"></canvas>
          </div>
        </div>
      </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    new Chart(
      document.getElementById('personalChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: {{ chart_labels|tojson }},
          datasets: [
            { label: 'Won',  data: {{ chart_won|tojson }},  fill: true, tension: 0.3 },
            { label: 'Lost', data: {{ chart_lost|tojson }}, fill: true, tension: 0.3 }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
      }
    );


    // —— Player Performance Chart —— 
    new Chart(
      document.getElementById('playerChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: {{ player_names|tojson }},
          datasets: [
            {
              label: 'Matches Played',
              data: {{ player_played|tojson }},
              backgroundColor: 'rgba(75,192,192,0.6)'
            },
            {
              label: 'Wins',
              data: {{ player_wins|tojson }},
              backgroundColor: 'rgba(153,102,255,0.6)'
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          }
        }
      }
    );

    
  </script>
{% endblock %}
